---
title: "Improve cs2 climate plots of temperature & concentration distributions from MAGICC"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 2
    code_folding: hide
    df_print: kable
  html_notebook:
      code_folding: hide
  pdf_document: default
---


```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(quitte)
library(readxl)
```

# Data!

Currently uses XLSX, unsure if this stays use `quitte` instead. Goal is to have a quitte Object. We need to do some more work before reshaping the dset and creating a quitte object from. This seems to depend on the XLSX itself and therefore other methods for reading it might produce different results. However, the most important part is to select for the variable to be displayed later on

```{r}
these_please <- c(
  # CO2 concentrations
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|95.0th Percentile",
  # NOTE: Theres not 5th Percentile on Surface Temperatures
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|10.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|90.0th Percentile",
  # CH4 Fluxes
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|95.0th Percentile"
)

ngfs_xlsx <- readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv-v2.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  # Cast yearly columns as doubles
  mutate_at(vars(starts_with(c("1", "2"))), as.double) %>% 
  # Exclude rows whose "Variable" column does not end in Percentile, because 
  # these do not contain numerical data in the columns for each year
  #filter(grepl("Percentile", Variable)) %>% 
  # Take only those variables that shall be plotted later on
  filter(Variable %in% these_please)

ngfs_xlsx
```

Now for the fun part: Reshaping the whole thang into a `quitte` object. Year columns need to become lines here. Can be done with `reshape2::melt`:

```{r}
reshape2::melt(
  ngfs_xlsx, 
  #id.vars = seq(1:5), 
  c("Model", "Scenario", "Region", "Variable", "Unit"),
  variable.name = "period"
)
```

Or with `dplyr::pivot_longer`:

```{r}
pivot_longer(ngfs_xlsx, starts_with(c("1", "2")), names_to = "period", values_to = "value")
```

Finally, create a `quitte` object (which is basically a list with specified columns)

```{r}
ngfs_data <- as.quitte(ngfs_xlsx %>% 
  pivot_longer(
    starts_with(c("1", "2")), 
    names_to = "period", 
    values_to = "value"
  )
)

ngfs_data <- as.quitte(ngfs_xlsx %>% 
  reshape2::melt(
    c("Model", "Scenario", "Region", "Variable", "Unit"),
    variable.name = "period"
  )
)

print(ngfs_data)
```

By the way:

```{r}
print(typeof(ngfs_data))
```

Our `quitte` object is now available an ready to be passed to the plotting function.

# Plotting!

Write a function that returns a `facet_wrap`

```{r}
plotPercentiles <- function(quitte_frame) {
  print("Hello!")
} 
#mip::plotPercentile(bar) ##
ngfs_data
```
Need to collect all the values for each year

```{r}
df <- ngfs_data %>% 
  mutate(
    "percentile" = stringr::str_extract( variable, "[^\\|]+?$"),
    "variable"   = gsub("\\|[^\\|]+$", "", variable)
  ) %>%
  pivot_wider(
    names_from = "percentile",  
    values_from = "value" 
  ) 

# colnames(df)
df
```

```{r}
ggplot() +
  geom_line(
    #data = filter(baz, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    #data = baz,
    #data = df,
    data = filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    aes(x = period, y = get("33.0th Percentile"), color=Percentile)
  )  
#facet_wrap(~variable, scales = "free")
```

```{r}

p <- ggplot() +
  geom_line(
    # data = df,
    data = filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    aes(x = period, y = get("50.0th Percentile"), group=1)
  ) +
  geom_ribbon(
    data = filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    aes(x = period, ymin = get("33.0th Percentile"), ymax = get("67.0th Percentile")),
    fill = "#68788a",
    alpha = 0.5
  ) +
  geom_ribbon(
    data = filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    aes(x = period, ymin = get("5.0th Percentile"), ymax = get("95.0th Percentile")),
    fill = "#68788a",
    alpha = 0.2
  )

print(p)
```
# Case: Multiple variables

```{r}
unique(df$variable)
```
```{r}
p <- ggplot()

for (variable in unique(df$variable)) {
  p <- p + 
    geom_line(
      # data = df,
      data = filter(df, variable == variable),
      aes(x = period, y = get("50.0th Percentile"), group=1)
    ) +
    geom_ribbon(
      data = filter(df, variable == variable),
      aes(x = period, ymin = get("33.0th Percentile"), ymax = get("67.0th Percentile")),
      fill = "#68788a",
      alpha = 0.5
    ) +
    geom_ribbon(
      data = filter(df, variable == variable),
      aes(x = period, ymin = get("5.0th Percentile"), ymax = get("95.0th Percentile")),
      fill = "#68788a",
      alpha = 0.2
    )
}

p <- p + facet_wrap(vars(variable), scales = "free")

print(p)
```

# Multiple scenario dataset 

In this dset, variables are now dublicates that belong to different scenarios. Again

0a) Read in data

```{r}
these_please <- c(
  # CO2 concentrations
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|95.0th Percentile" #,
  # NOTE: Theres not 5th Percentile on Surface Temperatures
  # "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|10.0th Percentile",
  # "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|33.0th Percentile",
  # "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|50.0th Percentile",
  # "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|67.0th Percentile",
  # "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|90.0th Percentile",
  # CH4 Fluxes
  # "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|5.0th Percentile",
  # "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|33.0th Percentile",
  # "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|50.0th Percentile",
  # "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|67.0th Percentile",
  # "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|95.0th Percentile"
)

ngfs_xlsx_2_scenarios <- readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv-v3-extended-scenarios.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  # Cast yearly columns as doubles
  mutate_at(vars(starts_with(c("1", "2"))), as.double) %>% 
  # Exclude rows whose "Variable" column does not end in Percentile, because 
  # these do not contain numerical data in the columns for each year
  #filter(grepl("Percentile", Variable)) %>% 
  # Take only those variables that shall be plotted later on
  filter(Variable %in% these_please)

ngfs_xlsx_2_scenarios
```

```{r}
unique(ngfs_xlsx_2_scenarios$Scenario)
```

0b) Transform to `quitte` object

```{r}
ngfs_data_2_scenarios <- as.quitte(ngfs_xlsx_2_scenarios %>% 
  reshape2::melt(
    c("Model", "Scenario", "Region", "Variable", "Unit"),
    variable.name = "period"
  )
)

# print(ngfs_data_2_scenarios)
unique(ngfs_data_2_scenarios$scenario)
```

1) Transform data

```{r}
df_2 <- ngfs_data_2_scenarios %>% 
  # group_by(scenario) %>%
  mutate(
    "percentile" = stringr::str_extract( variable, "[^\\|]+?$"),
    "variable"   = gsub("\\|[^\\|]+$", "", variable)
  ) %>%
  pivot_wider(
    names_from = "percentile",  
    values_from = "value" 
  ) 

# colnames(df_2)
# df_2
unique(df_2$scenario)
```

```{r}
p <- ggplot()

for (variable in unique(df_2$variable)) {
  for (scenario in unique(df_2$scenario)) {
    data <- filter(df_2, variable == variable & scenario == scenario)
    labels
    # print(unique(data$unit))
    p <- p + 
      geom_line(
        data = data, aes(x = period, y = get("50.0th Percentile"), group=1)
      ) +
      geom_ribbon(
        data = data, aes(x = period, ymin = get("33.0th Percentile"), ymax = get("67.0th Percentile")),
        fill = "#68788a",
        alpha = 0.5
      ) +
      geom_ribbon(
        data = data, aes(x = period, ymin = get("5.0th Percentile"), ymax = get("95.0th Percentile")),
        fill = "#68788a",
        alpha = 0.2
      ) 
  }
}

# p <- p + facet_wrap(vars(variable), scales = "free", ncol = length(unique(df_2$scenario)))
# p <- p + facet_wrap(vars(variable), scales = "free")
# p <- p + facet_wrap(vars(scenario, variable), scales = "free")
# p <- p + facet_wrap(vars(scenario, variable), scales = "free", 
#                     strip.position = "left",
#                     # strip.position = NULL, 
#                     labeller = as_labeller(c(A = "Currents (A)", V = "Voltage (V)"))) +
#   ylab(NULL) #+
#   theme(strip.background = element_blank(),
#         strip.placement = "outside")
# p <- p + facet_wrap(vars(scenario, variable), scales = "free")

# Using facet grid
p <- p + facet_grid(variable ~ scenario, scales = "free_y") +
  theme(
    axis.title.x = element_blank()
  ) + ylab(unique(df_2$unit))
# 

# p <- p + 
#   facet_wrap(
#     vars(scenario, variable), 
#     scales = "free_y") +
#   theme(
#     axis.title.x = element_blank(),
#     axis.title.y = element_blank()
#   )

print(p)
```
```{r}
unique(data$unit)
```


# The End

```{r}
knitr::knit_exit()
```

# Playground

## Learning `facet_wrap`

```{r}
library(ggplot2)
mpg2 <- subset(mpg, cyl != 5 & drv %in% c("4", "f") & class != "2seater")
print(mpg2)

base <- ggplot(mpg2, aes(displ, hwy)) + 
  #geom_blank() +  # Plots nothing
  geom_point() +  # Plots points
  xlab(NULL) + 
  ylab(NULL)

# base + facet_wrap(~class, ncol = 3)
base + facet_wrap("class", ncol = 3)
#base + facet_wrap(var(class), ncol = 3)  # Doesnt work
```

## Restructuring

```{r}
pnl <- tibble(
  x = 1:4,
  a = c(1, 1,0, 0),
  b = c(0, 1, 1, 1),
  y1 = rnorm(4),
  y2 = rnorm(4),
  z1 = rep(3, 4),
  z2 = rep(-2, 4),
)
print(pnl)

foo <- pnl %>% pivot_longer(
  cols = !c(x, a, b), 
  names_to = c(".value", "time"), 
  names_pattern = "(.)(.)"
)
print(foo)
```

## Miscellaneous

```{r}
#endsWith(x = ngfs_meta[, ncol(ngfs_meta)], suffix = "Percentile")
#ngfs_meta[, ncol(ngfs_meta)] %>% select(ends_with("Percentile"))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", ngfs_meta[, ncol(ngfs_meta)]))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", colnames(ngfs_meta)[ncol(ngfs_meta)]))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", "Variable_7"))  # Does not work
#grepl("Percentile", colnames(ngfs_meta)[ncol(ngfs_meta)])  # Same as above
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", Variable_7))  # Works
#ngfs_meta %>% filter(grepl("Percentile", Variable_7))  # Works
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", as.name(tail(names(ngfs_meta), 1))))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", as.symbol(tail(names(ngfs_meta), 1))))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", as.symbol(tail(names(.), 1))))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter()
#colnames(ngfs_meta)[ncol(ngfs_meta)]
#as.name(tail(names(ngfs_meta), 1))
#as.symbol(tail(names(ngfs_meta), 1))
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
#ngfs_meta %>% drop_na(contains("Variable"))
#ngfs_meta %>% filter(last_col() != "95.0th Percentile")
ngfs_meta %>% filter(ngfs_meta[, ncol(ngfs_meta)] == "95.0th Percentile")
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
ngfs_data <- readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  select(starts_with(c("Variable", "1", "2"))) %>%
  separate_wider_delim("Variable", delim = "|", names_sep = "_", too_few = "align_end") #%>%
  #drop_na(x, any_of(vars))
  #separate_wider_delim(cols = c("Variable"), delim="|")
  #data.frame(do.call('rbind', strsplit(as.character(ngfs_data$Variable), '|', fixed=TRUE))) %>%
  #drop("Variable")

#within(ngfs_meta, SOMETHING<-data.frame(do.call('rbind', strsplit(as.character(ngfs_meta$Variable), '|', fixed=TRUE))))

ngfs_data
```

## Concatenate string vectors and constants

```{r}
a <- 1:10
print(a)
b <- 11:20
print(b)
c <- c(a,b)
print(c)
d <- c(a,b, 5)
print(d)

print("String vectors")

a <- c("loooooooooooooooooooooooooooooooooooooooooooooooooooooooooong String", "bar")
print(a)
b <- c("baz")
print(b)
c <- c(a,b)
print(c)
d <- c(a,b, ".values")
print(d)
```

## Split `Variable` into dedicated columns
```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
data.frame(do.call('rbind', strsplit(as.character(ngfs_data$Variable), '|', fixed=TRUE)))
```

## Basic stuff
```{r}
c("X1", "X2", "X3", "X4", "X5", "X6", "X7")
c("X1", "X2", "X3", "X4", "X5")
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
#ngfs_meta |> separate_wider_delim("Variable", delim = "|", names_sep = "_")
ngfs_meta |> separate_wider_delim("Variable", delim = "|", names_sep = "_", names = c("X1", "X2", "X3", "X4", "X5", "X6", "X7"), too_few = "align_start")
#as.data.frame(ngfs_meta) |> separate_longer_delim("Variable", delim = "|")
#as.data.frame(ngfs_meta) |> separate_wider_delim("Variable", delim = "|", names = c("X1", "X2", "X3", "X4", "X5", "X6", "X7"))
#data.frame(do.call('rbind', strsplit(as.character(ngfs_data$Variable), '|', fixed=TRUE)))
```

# Graveyard

```{r}
these_please <- c(
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|95.0th Percentile"
)

percentile_from_variables <- function(variables) {
  return (stringr::str_split_i(variables, pattern = "\\|", i=-1))
}

df <- ngfs_data %>% 
  filter(Variable %in% these_please) %>% 
  # pivot_longer(starts_with(c("1", "2")))
  # pivot_longer(starts_with(c("1", "2")), names_to = these_please, names_sep = " ", values_to = "year") #%>%
  # pivot_longer_spec(starts_with(c("1", "2")), names_to = these_please, names_sep = " ", values_to = "year") #%>%
  # pivot_longer_spec(starts_with(c("1", "2")), names_to = c(".value", these_please), names_sep = " ", values_to = "year") #%>%
  #pivot_longer(starts_with(c("1", "2")), names_to = c(".value", these_please), names_pattern = "(.)(.)(.)")
  pivot_longer(starts_with(c("1", "2")), names_to = "Year", values_to = "Value") %>%
  #gather("year", "value", 3:ncol(ngfs_data), convert = TRUE) #%>%
  #gather("year", c("value_1", "value_2"), 3:ncol(ngfs_data)) #%>%
  #gather("year", "value", 3:ncol(ngfs_data), convert = as.integer) %>%
  #mutate_at(vars(c("year")), as.integer)
  pivot_wider(names_from = "Variable",  values_from = "Value") %>%
  rename_with(percentile_from_variables, starts_with("AR6 climate diagnostics")) %>%
  mutate_at(vars(c("Year")), as.integer)
df
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
ngfs_data <-   readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv-v2.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  select(starts_with(c("Variable", "Unit", "1", "2"))) %>%
  #filter(grepl("Percentile", Variable)) %>%  # Works
  filter(grepl("Percentile", Variable)) %>%  # Works
  #separate_wider_delim("Variable", delim = "|", names_sep = "_", too_few = "align_end") #%>%
  #gather("year", "value", 3:ncol(ngfs_meta))
  mutate_at(vars(starts_with(c("1", "2"))), as.double)

#within(ngfs_meta, SOMETHING<-data.frame(do.call('rbind', strsplit(as.character(ngfs_meta$Variable), '|', fixed=TRUE))))

ngfs_data
```
