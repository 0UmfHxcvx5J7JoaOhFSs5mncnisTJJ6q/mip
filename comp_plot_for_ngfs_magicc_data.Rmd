---
title: "Improve cs2 climate plots of temperature & concentration distributions from MAGICC"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 2
    code_folding: hide
    df_print: kable
  html_notebook:
      code_folding: hide
  pdf_document: default
---


```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(quitte)
library(readxl)
```

# Data!

Currently uses XLSX, unsure if this stays use `quitte` instead. Goal is to have a quitte Object. We need to do some more work before reshaping the dset and creating a quitte object from. This seems to depend on the XLSX itself and therefore other methods for reading it might produce different results. However, the most important part is to select for the variable to be displayed later on

```{r}
these_please <- c(
  # CO2 concentrations
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|95.0th Percentile",
  # NOTE: Theres not 5th Percentile on Surface Temperatures
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|10.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|90.0th Percentile",
  # CH4 Fluxes
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|95.0th Percentile"
)

ngfs_xlsx <- readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv-v2.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  # Cast yearly columns as doubles
  mutate_at(vars(starts_with(c("1", "2"))), as.double) %>% 
  # Exclude rows whose "Variable" column does not end in Percentile, because 
  # these do not contain numerical data in the columns for each year
  #filter(grepl("Percentile", Variable)) %>% 
  # Take only those variables that shall be plotted later on
  filter(Variable %in% these_please)

ngfs_xlsx
```

Now for the fun part: Reshaping the whole thang into a `quitte` object. Year columns need to become lines here. Can be done with `reshape2::melt`:

```{r}
reshape2::melt(
  ngfs_xlsx, 
  #id.vars = seq(1:5), 
  c("Model", "Scenario", "Region", "Variable", "Unit"),
  variable.name = "period"
)
```

Or with `dplyr::pivot_longer`:

```{r}
pivot_longer(ngfs_xlsx, starts_with(c("1", "2")), names_to = "period", values_to = "value")
```

Finally, create a `quitte` object (which is basically a list with specified columns)

```{r}
ngfs_data <- as.quitte(ngfs_xlsx %>% 
  pivot_longer(
    starts_with(c("1", "2")), 
    names_to = "period", 
    values_to = "value"
  )
)

ngfs_data <- as.quitte(ngfs_xlsx %>% 
  reshape2::melt(
    c("Model", "Scenario", "Region", "Variable", "Unit"),
    variable.name = "period"
  )
)

print(ngfs_data)
```

By the way:

```{r}
print(typeof(ngfs_data))
```

Our `quitte` object is now available an ready to be passed to the plotting function.

# Plotting!

Write a function that returns a `facet_wrap`

```{r}
#mip::plotPercentile(bar) ##
ngfs_data
```
Need to collect all the values for each year

```{r}
df <- ngfs_data %>% 
  mutate(
    "percentile" = stringr::str_extract( variable, "[^\\|]+?$"),
    "variable"   = gsub("\\|[^\\|]+$", "", variable)
  ) %>%
  pivot_wider(
    names_from = "percentile",  
    values_from = "value" 
  ) 

# colnames(df)
df
```

```{r}

p <- ggplot() +
  geom_line(
    # data = df,
    data = filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    aes(x = period, y = get("50.0th Percentile"), group=1)
  ) +
  geom_ribbon(
    data = filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    aes(x = period, ymin = get("33.0th Percentile"), ymax = get("67.0th Percentile")),
    fill = "#68788a",
    alpha = 0.5
  ) +
  geom_ribbon(
    data = filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"),
    aes(x = period, ymin = get("5.0th Percentile"), ymax = get("95.0th Percentile")),
    fill = "#68788a",
    alpha = 0.2
  )

print(p)
```
# Case: Multiple variables

```{r}
unique(df$variable)
```
```{r}
p <- ggplot()

for (variable in unique(df$variable)) {
  p <- p + 
    geom_line(
      # data = df,
      data = filter(df, variable == variable),
      aes(x = period, y = get("50.0th Percentile"), group=1)
    ) +
    geom_ribbon(
      data = filter(df, variable == variable),
      aes(x = period, ymin = get("33.0th Percentile"), ymax = get("67.0th Percentile")),
      fill = "#68788a",
      alpha = 0.5
    ) +
    geom_ribbon(
      data = filter(df, variable == variable),
      aes(x = period, ymin = get("5.0th Percentile"), ymax = get("95.0th Percentile")),
      fill = "#68788a",
      alpha = 0.2
    )
}

p <- p + facet_wrap(vars(variable), scales = "free")

print(p)
```

# Multiple scenario dataset 

In this dset, variables are now dublicates that belong to different scenarios. Again

0a) Read in data

```{r}
these_please <- c(
  # CO2 concentrations
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|95.0th Percentile",
  # NOTE: Theres not 5th Percentile on Surface Temperatures
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|10.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|90.0th Percentile",
  # CH4 Fluxes
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Net Land to Atmosphere Flux due to Permafrost|CH4|MAGICCv7.5.3|95.0th Percentile"
)

ngfs_xlsx_2_scenarios <- readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv-v3-extended-scenarios.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  # Cast yearly columns as doubles
  mutate_at(vars(starts_with(c("1", "2"))), as.double) %>% 
  # Exclude rows whose "Variable" column does not end in Percentile, because 
  # these do not contain numerical data in the columns for each year
  #filter(grepl("Percentile", Variable)) %>% 
  # Take only those variables that shall be plotted later on
  filter(Variable %in% these_please)

ngfs_xlsx_2_scenarios
```

```{r}
unique(ngfs_xlsx_2_scenarios$Scenario)
```

0b) Transform to `quitte` object

```{r}
ngfs_data_2_scenarios <- as.quitte(ngfs_xlsx_2_scenarios %>% 
  reshape2::melt(
    c("Model", "Scenario", "Region", "Variable", "Unit"),
    variable.name = "period"
  )
)

# print(ngfs_data_2_scenarios)
unique(ngfs_data_2_scenarios$scenario)
```

1) Transform data

```{r}
df_2 <- ngfs_data_2_scenarios %>% 
  mutate(
    "percentile" = stringr::str_extract( variable, "[^\\|]+?$"),
    "variable"   = gsub("\\|[^\\|]+$", "", variable)
  ) %>%
  pivot_wider(
    names_from = "percentile",  
    values_from = "value" 
  ) 

# colnames(df_2)
# df_2
unique(df_2$scenario)
```

```{r}
p <- ggplot()

for (variable in unique(df_2$variable)) {
  for (scenario in unique(df_2$scenario)) {
    data <- filter(df_2, variable == variable & scenario == scenario)
    p <- p + 
      geom_line(
        data = data, aes(x = period, y = get("50.0th Percentile"), group=1)
      ) +
      geom_ribbon(
        data = data, aes(x = period, ymin = get("33.0th Percentile"), ymax = get("67.0th Percentile")),
        fill = "#68788a",
        alpha = 0.5
      ) +
      geom_ribbon(
        data = data, aes(x = period, ymin = get("5.0th Percentile"), ymax = get("95.0th Percentile")),
        fill = "#68788a",
        alpha = 0.2
      ) 
  }
}

# p <- p + facet_wrap(vars(variable), scales = "free", ncol = length(unique(df_2$scenario)))
# p <- p + facet_wrap(vars(variable), scales = "free")
# p <- p + facet_wrap(vars(scenario, variable), scales = "free")
# p <- p + facet_wrap(vars(scenario, variable), scales = "free", 
#                     strip.position = "left",
#                     # strip.position = NULL, 
#                     labeller = as_labeller(c(A = "Currents (A)", V = "Voltage (V)"))) +
#   ylab(NULL) #+
#   theme(strip.background = element_blank(),
#         strip.placement = "outside")
# p <- p + facet_wrap(vars(scenario, variable), scales = "free")

# Using facet grid
p <- p + facet_grid(variable ~ scenario, scales = "free_y") +
  theme(
    axis.title.x = element_blank()
  ) + ylab(unique(df_2$unit))
# 

# p <- p + 
#   facet_wrap(
#     vars(scenario, variable), 
#     scales = "free_y") +
#   theme(
#     axis.title.x = element_blank(),
#     axis.title.y = element_blank()
#   )

print(p)
```
```{r}
unique(data$unit)
```
# Functionalize!

```{r}
plotPercentiles <- function(quitte_frame, scenarios=NULL, variables=NULL, percentiles=NULL) {
  
  # TODO: Test for error cases (eg. check if scenarios are actually present in the data)
  
  # TODO: How to provide percentiles?
  # - NULL: Use 33, 66, 5, 95 as default
  # - SAME: List of length 2 or length 4, eg [33, 66, 10, 90]
  # - DIFF: List of Lists of length 2 or length 4, eg [33, 66, 10, 90]
  if (is.null(percentiles)) {
    these_percentiles <- c(5, 95, 33, 67)
  # } else if (length(percentiles)) {
  #   these_percentiles <- percentiles
  } else {

  }
  # 
  # format_str <- "$[.1f]{which}th Percentile"
  # these_percentiles <- ifelse(is.null(percentiles), NULL, stringr::str_interp(format_str, percentiles))
  # 
  inner_min <- stringr::str_interp(format_str, list(which=as.double(these_percentiles[1])))
  inner_max <- stringr::str_interp(format_str, list(which=as.double(these_percentiles[2])))
  outer_min <- stringr::str_interp(format_str, list(which=as.double(these_percentiles[3])))
  outer_max <- stringr::str_interp(format_str, list(which=as.double(these_percentiles[4])))
  
  # print(scenarios)
  # print(variables)
  # print("--- LENGTHS ---")
  # print(length(scenarios))
  # print(length(variables))
  # print("--- FOR scenarios ---")
  # for (foo in scenarios) {print(foo)}
  # print("--- FOR variables ---")
  # for (bar in variables) {print(bar)}
  
  df <- quitte_frame %>% 
    mutate(
      "percentile" = stringr::str_extract(variable, "[^\\|]+?$"),
      "variable"   = gsub("\\|[^\\|]+$", "", variable)
    ) %>%
    pivot_wider(
      names_from = "percentile",  
      values_from = "value" 
    )
  
  these_scenarios <- if (is.null(scenarios)) unique(df$scenario) else scenarios
  these_variables <- if (is.null(variables)) unique(df$variable) else variables
  
  # these_scenarios <- ifelse(is.null(scenarios), as.character(unique(df$scenario)), sapply(scenarios, function(i) i))
  # these_variables <- ifelse(is.null(variables), unique(df$variable), sapply(variables, function(i) i))
  # these_scenarios <- ifelse(is.null(scenarios), as.character(unique(df$scenario)), scenarios)
  # these_variables <- ifelse(is.null(variables), unique(df$variable), variables)
  
  # if (is.null(scenarios)) 
  #   these_scenarios <- unique(df$scenario)
  # } else {
  #   these_scenarios <- scenarios
  # }
  # if (is.null(variables)) {
  #   these_variables <- unique(df$variable)
  # } else {
  #   these_variables <- variables
  # }
  
  # print("--- FOR these_scenarios ---")
  # for (foo in these_scenarios) {print(foo)}
  # print("--- FOR these_variables ---")
  # for (bar in these_variables) {print(bar)}
  
  # if (is.null(scenarios) & is.null(variables)) {
  #   these_scenarios <- unique(df$scenario)
  #   these_variables <- unique(df$variable)
  # } else if (!is.null(scenarios)) {
  #   these_scenarios <- scenarios
  #   these_variables <- unique(df$variable)
  # } else if (!is.null(variables)) {
  #   these_scenarios <- unique(df$scenario)
  #   these_variables <- variables
  # } else {
  #   these_scenarios <- scenarios
  #   these_variables <- variables
  # }
  
  # print("--- CONTENT ---")
  # print(these_scenarios)
  # print(these_variables)
  # print("--- LENGTHS ---")
  # print(length(these_scenarios))
  # print(length(these_variables))
  # print("--- TYPES ---")
  # print(typeof(these_scenarios))
  # print(typeof(these_variables))
  # print("-------------")
  
  print("--- WHICH ---")
  print(paste0("these_scenarios: ", these_scenarios))
  print(paste0("these_variables: ", these_variables))
  
  print("--- PERCENTILES ---")
  print(paste0("outer_max: ", outer_max))
  print(paste0("inner_max: ", inner_max))
  print(paste0("inner_min: ", inner_min))
  print(paste0("outer_min: ", outer_min))
  
  p <- ggplot()
  
  print("--- PLOT ---")
  for (this_variable in these_variables) {
    print(this_variable)
    for (this_scenario in these_scenarios) {
      print(this_scenario)
      # print(paste0(variable, scenario))
      data <- filter(df, variable == this_variable & scenario == this_scenario)
      print(data)
      p <- p + 
        geom_line(
          # data = data, aes(x = period, y = get("50.0th Percentile"), group=1)
          data = data, aes(x = period, y = get("50.0th Percentile"))
        ) +
        geom_ribbon(
          # data = data, aes(x = period, ymin = get(inner_min), ymax = get(inner_max)),
          data = data, aes(x = period, ymin = get("33.0th Percentile"), ymax = get("67.0th Percentile")),
          fill = "#68788a", alpha = 0.5
        ) +
        geom_ribbon(
          # data = data, aes(x = period, ymin = get(outer_min), ymax = get(outer_max)),
          data = data, aes(x = period, ymin = get("5.0th Percentile"), ymax = get("95.0th Percentile")),
          fill = "#68788a", alpha = 0.2
        ) 
    }
  }
  
  # if (length(scenarios) == 1) {
  if (length(these_scenarios) == 1) {
    p <- p +
      facet_wrap(
        vars(variable),
        scales = "free_y") +
      theme(
        axis.title.x = element_blank()
      ) +
      ylab(
        unique(df$unit))
  # } else if (!is.null(variables)) {
  } else if (length(these_variables) == 1) {
    p <- p +
      facet_wrap(
        vars(scenario)) +
      theme(
        axis.title.x = element_blank()
      ) +
      ylab(
        unique(df$unit))
  }
  else {
    # Using facet grid
    p <- p +
      facet_grid(
        variable ~ scenario,
        scales = "free_y") +
      theme(
        axis.title.x = element_blank()
      ) +
      ylab(
        unique(df$unit))
  }
  
  # p <- p +
  #     facet_grid(
  #       variable ~ scenario,
  #       scales = "free_y") +
  #     theme(
  #       axis.title.x = element_blank()
  #     ) +
  #     ylab(
  #       unique(df$unit))

  return(p)
} 

# print(plotPercentiles(ngfs_data_2_scenarios))
# print(plotPercentiles(ngfs_data_2_scenarios, which = "scenarios"))
# print(plotPercentiles(ngfs_data_2_scenarios, which = "variables"))
# print(plotPercentiles(ngfs_data_2_scenarios, which = "both"))
# try(print(plotPercentiles(ngfs_data_2_scenarios, which = "asd")))

# print(plotPercentiles(ngfs_data_2_scenarios, variables = c("AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3")))
print(plotPercentiles(ngfs_data_2_scenarios, scenarios = c("d_another")))

# print(plotPercentiles(ngfs_data_2_scenarios, scenarios = c("d_another", "d_delfrag")))
# print(plotPercentiles(ngfs_data_2_scenarios))
# print(plotPercentiles(ngfs_data_2_scenarios, scenarios = c("d_another"), variables = c("AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3")))
# print(plotPercentiles(ngfs_data_2_scenarios, scenarios = c("d_another"), variables = c("AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3", "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3")))
# print(plotPercentiles(ngfs_data_2_scenarios, variables = c("AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3", "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3")))
# print(plotPercentiles(ngfs_data_2_scenarios, scenarios = c("d_another", "d_delfrag"), variables = c("AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3", "AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3")))

```



```{r}
filter(df, variable == "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3" & scenario == scenario)
```


## Function tests

Must use pre-processed `ngfs_data_2_scenarios`

```{r}
# print(plotPercentiles(ngfs_data_2_scenarios))
# print(plotPercentiles(ngfs_data_2_scenarios, which = "scenarios"))
# print(plotPercentiles(ngfs_data_2_scenarios, which = "variables"))
# print(plotPercentiles(ngfs_data_2_scenarios, which = "both"))
# try(print(plotPercentiles(ngfs_data_2_scenarios, which = "asd")))

print(plotPercentiles(ngfs_data_2_scenarios, scenarios = c("d_another", "d_delfrag")))
# print(plotPercentiles(ngfs_data_2_scenarios, variables = c("AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3")))
# print(plotPercentiles(ngfs_data_2_scenarios))

```

# The End

```{r}
knitr::knit_exit()
```

# Playground


```{r}
# print(ngfs_data_2_scenarios)

which_example = "variables=AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3"
#which_example = "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|33.0th Percentile"
# which_example = "variables=AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3,AR6 climate diagnostics|Surface Temperature (GSAT)|MAGICCv7.5.3|90.0th Percentile"

print(stringr::str_split(gsub(pattern = "variables\\=", x = which_example, replacement = ""), pattern = ","))


```

## Learning `facet_wrap`

```{r}
library(ggplot2)
mpg2 <- subset(mpg, cyl != 5 & drv %in% c("4", "f") & class != "2seater")
print(mpg2)

base <- ggplot(mpg2, aes(displ, hwy)) + 
  #geom_blank() +  # Plots nothing
  geom_point() +  # Plots points
  xlab(NULL) + 
  ylab(NULL)

# base + facet_wrap(~class, ncol = 3)
base + facet_wrap("class", ncol = 3)
#base + facet_wrap(var(class), ncol = 3)  # Doesnt work
```

## Restructuring

```{r}
pnl <- tibble(
  x = 1:4,
  a = c(1, 1,0, 0),
  b = c(0, 1, 1, 1),
  y1 = rnorm(4),
  y2 = rnorm(4),
  z1 = rep(3, 4),
  z2 = rep(-2, 4),
)
print(pnl)

foo <- pnl %>% pivot_longer(
  cols = !c(x, a, b), 
  names_to = c(".value", "time"), 
  names_pattern = "(.)(.)"
)
print(foo)
```

## Miscellaneous

```{r}
#endsWith(x = ngfs_meta[, ncol(ngfs_meta)], suffix = "Percentile")
#ngfs_meta[, ncol(ngfs_meta)] %>% select(ends_with("Percentile"))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", ngfs_meta[, ncol(ngfs_meta)]))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", colnames(ngfs_meta)[ncol(ngfs_meta)]))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", "Variable_7"))  # Does not work
#grepl("Percentile", colnames(ngfs_meta)[ncol(ngfs_meta)])  # Same as above
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", Variable_7))  # Works
#ngfs_meta %>% filter(grepl("Percentile", Variable_7))  # Works
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", as.name(tail(names(ngfs_meta), 1))))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", as.symbol(tail(names(ngfs_meta), 1))))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter(grepl("Percentile", as.symbol(tail(names(.), 1))))  # Does not work
#ngfs_meta[, ncol(ngfs_meta)] %>% filter()
#colnames(ngfs_meta)[ncol(ngfs_meta)]
#as.name(tail(names(ngfs_meta), 1))
#as.symbol(tail(names(ngfs_meta), 1))
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
#ngfs_meta %>% drop_na(contains("Variable"))
#ngfs_meta %>% filter(last_col() != "95.0th Percentile")
ngfs_meta %>% filter(ngfs_meta[, ncol(ngfs_meta)] == "95.0th Percentile")
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
ngfs_data <- readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  select(starts_with(c("Variable", "1", "2"))) %>%
  separate_wider_delim("Variable", delim = "|", names_sep = "_", too_few = "align_end") #%>%
  #drop_na(x, any_of(vars))
  #separate_wider_delim(cols = c("Variable"), delim="|")
  #data.frame(do.call('rbind', strsplit(as.character(ngfs_data$Variable), '|', fixed=TRUE))) %>%
  #drop("Variable")

#within(ngfs_meta, SOMETHING<-data.frame(do.call('rbind', strsplit(as.character(ngfs_meta$Variable), '|', fixed=TRUE))))

ngfs_data
```

## Concatenate string vectors and constants

```{r}
a <- 1:10
print(a)
b <- 11:20
print(b)
c <- c(a,b)
print(c)
d <- c(a,b, 5)
print(d)

print("String vectors")

a <- c("loooooooooooooooooooooooooooooooooooooooooooooooooooooooooong String", "bar")
print(a)
b <- c("baz")
print(b)
c <- c(a,b)
print(c)
d <- c(a,b, ".values")
print(d)
```

## Split `Variable` into dedicated columns
```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
data.frame(do.call('rbind', strsplit(as.character(ngfs_data$Variable), '|', fixed=TRUE)))
```

## Basic stuff
```{r}
c("X1", "X2", "X3", "X4", "X5", "X6", "X7")
c("X1", "X2", "X3", "X4", "X5")
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
#ngfs_meta |> separate_wider_delim("Variable", delim = "|", names_sep = "_")
ngfs_meta |> separate_wider_delim("Variable", delim = "|", names_sep = "_", names = c("X1", "X2", "X3", "X4", "X5", "X6", "X7"), too_few = "align_start")
#as.data.frame(ngfs_meta) |> separate_longer_delim("Variable", delim = "|")
#as.data.frame(ngfs_meta) |> separate_wider_delim("Variable", delim = "|", names = c("X1", "X2", "X3", "X4", "X5", "X6", "X7"))
#data.frame(do.call('rbind', strsplit(as.character(ngfs_data$Variable), '|', fixed=TRUE)))
```

# Graveyard

```{r}
these_please <- c(
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|5.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|33.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|50.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|67.0th Percentile",
  "AR6 climate diagnostics|Atmospheric Concentrations|CO2|MAGICCv7.5.3|95.0th Percentile"
)

percentile_from_variables <- function(variables) {
  return (stringr::str_split_i(variables, pattern = "\\|", i=-1))
}

df <- ngfs_data %>% 
  filter(Variable %in% these_please) %>% 
  # pivot_longer(starts_with(c("1", "2")))
  # pivot_longer(starts_with(c("1", "2")), names_to = these_please, names_sep = " ", values_to = "year") #%>%
  # pivot_longer_spec(starts_with(c("1", "2")), names_to = these_please, names_sep = " ", values_to = "year") #%>%
  # pivot_longer_spec(starts_with(c("1", "2")), names_to = c(".value", these_please), names_sep = " ", values_to = "year") #%>%
  #pivot_longer(starts_with(c("1", "2")), names_to = c(".value", these_please), names_pattern = "(.)(.)(.)")
  pivot_longer(starts_with(c("1", "2")), names_to = "Year", values_to = "Value") %>%
  #gather("year", "value", 3:ncol(ngfs_data), convert = TRUE) #%>%
  #gather("year", c("value_1", "value_2"), 3:ncol(ngfs_data)) #%>%
  #gather("year", "value", 3:ncol(ngfs_data), convert = as.integer) %>%
  #mutate_at(vars(c("year")), as.integer)
  pivot_wider(names_from = "Variable",  values_from = "Value") %>%
  rename_with(percentile_from_variables, starts_with("AR6 climate diagnostics")) %>%
  mutate_at(vars(c("Year")), as.integer)
df
```

```{r, fig.width=5, fig.height=5, message = FALSE, warning = FALSE}
ngfs_data <-   readxl::read_xlsx(
  "~/../lab/misc_data/ngfs-magicc-data-from-csv-v2.xlsx",
  sheet = "ngfs-magicc-data"
) %>%
  select(starts_with(c("Variable", "Unit", "1", "2"))) %>%
  #filter(grepl("Percentile", Variable)) %>%  # Works
  filter(grepl("Percentile", Variable)) %>%  # Works
  #separate_wider_delim("Variable", delim = "|", names_sep = "_", too_few = "align_end") #%>%
  #gather("year", "value", 3:ncol(ngfs_meta))
  mutate_at(vars(starts_with(c("1", "2"))), as.double)

#within(ngfs_meta, SOMETHING<-data.frame(do.call('rbind', strsplit(as.character(ngfs_meta$Variable), '|', fixed=TRUE))))

ngfs_data
```
